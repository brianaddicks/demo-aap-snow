---
- name: Update all packages
  hosts: vcenter
  gather_facts: false
  vars:
    - vcenter_creds: &vcenter_conn
        hostname: "{{ lookup('ansible.builtin.env', 'VMWARE_HOST') }}"
        username: "{{ lookup('ansible.builtin.env', 'VMWARE_USER') }}"
        password: "{{ lookup('ansible.builtin.env', 'VMWARE_PASSWORD') }}"
        datacenter: '{{ vcenter_datacenter }}'
        name: '{{ vm_name }}'

  tasks:
    - name: Create a snapshot
      community.vmware.vmware_guest_snapshot:
        <<: *vcenter_conn
        datacenter: "{{ vcenter_datacenter }}"
        folder: "/{{ vcenter_datacenter }}/vm/{{ vcenter_vm_folder }}"
        name: "{{ vm_name }}"
        state: present
        snapshot_name: pre-patching
        description: pre-patching
      delegate_to: localhost


